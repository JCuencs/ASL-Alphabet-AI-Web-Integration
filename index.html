<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign Language Alphabet Recognition</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #6cbeed; min-height: 100vh; padding: 20px; }
.container { max-width: 1400px; margin: 0 auto; }
h1 { text-align: center; color: white; font-size: 2.5rem; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
.main-content { display: flex; gap: 20px; align-items: flex-start; }
.left-section { flex: 1; display: flex; flex-direction: column; gap: 20px; position: relative; }

.video-container {
  background: white;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  position: relative;
  overflow: hidden;
  padding: 0;
}

#webcam {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 15px;
}

#canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  border-radius: 15px;
}

.prediction-box { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); text-align: center; }
.prediction-label { font-size: 1.2rem; color: #333; margin-bottom: 15px; font-weight: 600; }
.prediction-text {
  font-size: 2.5rem; font-weight: bold; color: #6cbeed; min-height: 80px;
  display: flex; flex-wrap: wrap; align-items: center; justify-content: center;
  border: 3px solid #e0e0e0; border-radius: 10px; background: #f9f9f9;
  padding: 10px; word-break: break-word; line-height: 1.2;
}
.button-group { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
.button-group button {
  padding: 12px 24px; font-size: 1rem; font-weight: 600; color: #fff;
  background-color: #6cbeed; border: none; border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer;
  transition: all 0.2s ease-in-out; min-width: 140px;
}
.button-group button:hover { background-color: #5aa0d4; transform: translateY(-2px); box-shadow: 0 7px 20px rgba(0,0,0,0.3); }
.button-group button:active { transform: translateY(0); }
.button-group button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
.chart-container { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); flex: 0 0 400px; }
.chart-title { font-size: 1.3rem; color: #333; margin-bottom: 15px; text-align: center; font-weight: 600; }
.chart-image { width: 100%; height: auto; border-radius: 10px; }
.status { text-align: center; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px; color: white; margin-bottom: 20px; font-weight: 500; }
.model-selector-container { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.model-selector-label { font-size: 0.9rem; color: #666; margin-bottom: 8px; font-weight: 600; }
.model-selector { width: 100%; padding: 10px; font-size: 1rem; border: 2px solid #6cbeed; border-radius: 8px; background: white; cursor: pointer; }
.confidence-container {
  position: absolute;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 8px 16px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 0.95rem;
  z-index: 5;
}
.prediction-status { font-size: 0.9rem; color: #666; margin-top: 10px; font-weight: 500; }
.prediction-status.active { color: #4CAF50; }
.prediction-status.inactive { color: #f44336; }

@media (max-width: 768px) {
  h1 { font-size: 1.8rem; margin-bottom: 20px; }
  .main-content { flex-direction: column; }
  .chart-container { flex: none; width: 100%; }
  .prediction-text { font-size: 2rem; min-height: 60px; }
  .button-group button { min-width: 110px; padding: 10px 16px; font-size: 0.9rem; }
  #canvas { top: 0; left: 0; width: 100%; height: 100%; }
}
</style>
</head>
<body>
<div class="container">
<h1>Sign Language Alphabet</h1>

<div class="status" id="status">Initializing camera...</div>

<div class="main-content">
    <div class="left-section">
        <div class="model-selector-container">
            <div class="model-selector-label">Select Model:</div>
            <select id="model-selector" class="model-selector">
                <option value="lstm">Light</option>
                <option value="transformer">Standard</option>
            </select>
        </div>

        <div class="video-container">
            <video id="webcam" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="confidence-container">
                <span id="confidence">Confidence: 0%</span>
            </div>
        </div>

        <div class="prediction-box">
            <div class="prediction-label">Predicted Letters</div>
            <div class="prediction-text" id="prediction">-</div>
            <div class="prediction-status" id="prediction-status">Status: Inactive</div>

            <div class="button-group">
                <button id="toggle-btn">Start</button>
                <button id="reset-btn">Clear</button>
                <button id="speak-btn">Speak</button>
            </div>
        </div>

        <div class="chart-container" id="chart-mobile" style="display: none;">
            <div class="chart-title">Sign Language Guide</div>
            <img src="/ASL-Alphabet-poster-flashcards.png" 
                 alt="Sign Language Alphabet Chart" 
                 class="chart-image"
                 onerror="this.src='https://www.abcya.com/media/2020/11/sign-language-alphabet-reference-sheet.jpg'">
        </div>
    </div>

    <div class="chart-container" id="chart-desktop">
        <div class="chart-title">Sign Language Guide</div>
        <img src="/ASL-Alphabet-poster-flashcards.png" 
             alt="Sign Language Alphabet Chart" 
             class="chart-image"
             onerror="this.src='https://www.abcya.com/media/2020/11/sign-language-alphabet-reference-sheet.jpg'">
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
const API_URL = 'http://localhost:5000/api';
const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

let hands, pose;
let camera;
const videoElement = document.getElementById('webcam');
const canvasElement = document.getElementById('canvas');
const canvasCtx = canvasElement.getContext('2d');
const predictionElement = document.getElementById('prediction');
const statusElement = document.getElementById('status');
const confidenceElement = document.getElementById('confidence');
const predictionStatusElement = document.getElementById('prediction-status');

let sequence = [];
const SEQUENCE_LENGTH = 30;
let predicting = false;
let frameCount = 0;
const PREDICTION_INTERVAL = 10;
let lastPredictedLetter = '';
let sameLetterCount = 0;
const SAME_LETTER_THRESHOLD = 3;
let selectedModel = 'lstm';

const toggleBtn = document.getElementById('toggle-btn');
const resetBtn = document.getElementById('reset-btn');
const speakBtn = document.getElementById('speak-btn');

toggleBtn.addEventListener('click', () => { 
    predicting = !predicting;
    toggleBtn.textContent = predicting ? 'Stop' : 'Start';
    toggleBtn.style.backgroundColor = predicting ? '#f44336' : '#6cbeed';
    if (predicting) sequence = [];
    updatePredictionStatus();
});

resetBtn.addEventListener('click', () => { 
    predictionElement.textContent = '-'; 
    lastPredictedLetter = '';
    sameLetterCount = 0;
    confidenceElement.textContent = 'Confidence: 0%';
});

speakBtn.addEventListener('click', () => {
    const text = predictionElement.textContent;
    if (text && text !== '-') speakText(text);
});

function updatePredictionStatus() {
    if (predicting) {
        predictionStatusElement.textContent = 'Status: Active';
        predictionStatusElement.className = 'prediction-status active';
    } else {
        predictionStatusElement.textContent = 'Status: Inactive';
        predictionStatusElement.className = 'prediction-status inactive';
    }
}

document.getElementById('model-selector').addEventListener('change', (e) => {
    selectedModel = e.target.value;
    statusElement.textContent = `Switched to ${selectedModel.toUpperCase()} model`;
});

// Text-to-Speech
function speakText(text) {
    window.speechSynthesis.cancel();
    for (let i=0;i<text.length;i++){
        setTimeout(()=>{
            const utterance = new SpeechSynthesisUtterance(text[i]);
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }, i*600);
    }
}

// Health check
async function checkBackendHealth() {
    try {
        const response = await fetch(`${API_URL}/health`);
        const data = await response.json();
        statusElement.textContent = (data.status === 'healthy') ? 'Ready! You may start signing.' : 'Backend not healthy';
    } catch (err) {
        console.error(err);
        statusElement.textContent = 'Cannot connect to backend. Please start the Flask server.';
    }
}

// ----------- Initialize MediaPipe Hands + Pose -----------
async function initializeHandsPose() {
    hands = new Hands({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

    pose = new Pose({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

    hands.onResults(onResults);
    pose.onResults(onResults);
}

// ----------- Keypoint extraction -----------
function extractKeypoints(handsResults, poseResults) {
    let poseArray = poseResults?.poseLandmarks?.flatMap(l => [l.x,l.y,l.z,l.visibility]) ?? new Array(33*4).fill(0);
    let leftHandArray = new Array(21*3).fill(0);
    let rightHandArray = new Array(21*3).fill(0);

    if (handsResults?.multiHandLandmarks && handsResults?.multiHandedness){
        handsResults.multiHandLandmarks.forEach((landmarks, idx)=>{
            const label = handsResults.multiHandedness[idx].label;
            const arr = landmarks.flatMap(l => [l.x,l.y,l.z]);
            if(label==='Left') leftHandArray = arr;
            else if(label==='Right') rightHandArray = arr;
        });
    }

    return [...poseArray, ...leftHandArray, ...rightHandArray]; // 258 features
}

function isValidGesture(handsResults) {
    return handsResults?.multiHandLandmarks?.length > 0;
}

// ----------- Prediction -----------
async function predictSequence(keypoints, handsResults) {
    if (!predicting || !isValidGesture(handsResults)) { confidenceElement.textContent = 'Confidence: 0%'; return; }
    sequence.push(keypoints);
    if (sequence.length > SEQUENCE_LENGTH) sequence.shift();
    frameCount++;

    if (sequence.length===SEQUENCE_LENGTH && frameCount%PREDICTION_INTERVAL===0){
        try {
            const res = await fetch(`${API_URL}/predict`,{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({sequence, model:selectedModel})
            });
            const data = await res.json();
            const predictedLetter = data.prediction;
            const confidence = data.confidence*100;
            confidenceElement.textContent = `Confidence: ${confidence.toFixed(0)}%`;

            if(confidence>=70){
                if(predictedLetter===lastPredictedLetter) sameLetterCount++;
                else { lastPredictedLetter=predictedLetter; sameLetterCount=1; }

                if(sameLetterCount>=SAME_LETTER_THRESHOLD){
                    if(predictionElement.textContent==='-') predictionElement.textContent='';
                    const currentText = predictionElement.textContent;
                    if(currentText.slice(-1)!==predictedLetter) predictionElement.textContent+=predictedLetter;
                    sameLetterCount=0;
                }
            }
        } catch(err){
            console.error('Prediction error:', err);
            statusElement.textContent='Prediction failed.';
        }
    }
}

// ----------- Draw landmarks -----------
function drawLandmarks(handsResults, poseResults){
    canvasCtx.clearRect(0,0,canvasElement.width,canvasElement.height);
    canvasCtx.drawImage(videoElement,0,0,canvasElement.width,canvasElement.height);

    if(poseResults?.poseLandmarks) drawConnectors(canvasCtx, poseResults.poseLandmarks, POSE_CONNECTIONS,{color:'white',lineWidth:2}), drawLandmarks(canvasCtx,poseResults.poseLandmarks,{color:'red',lineWidth:1});
    if(handsResults?.multiHandLandmarks) handsResults.multiHandLandmarks.forEach(l=>drawConnectors(canvasCtx,l,HAND_CONNECTIONS,{color:'white',lineWidth:2}),drawLandmarks(canvasCtx,l,{color:'green',lineWidth:1}));
}

// ----------- Combined Results callback -----------
let latestHandsResults=null, latestPoseResults=null;
function onResults(results){
    if(results.poseLandmarks) latestPoseResults=results;
    if(results.multiHandLandmarks) latestHandsResults=results;

    drawLandmarks(latestHandsResults, latestPoseResults);

    const keypoints = extractKeypoints(latestHandsResults, latestPoseResults);
    predictSequence(keypoints, latestHandsResults);
}

// ----------- Initialize Camera -----------
async function initializeCamera(){
    camera = new Camera(videoElement,{
        onFrame: async ()=>{
            await hands.send({image:videoElement});
            await pose.send({image:videoElement});
        },
        width:1280,
        height:720
    });
    await camera.start();
    statusElement.textContent='Camera ready! Initializing models...';
    await checkBackendHealth();
}

// ----------- Initialize everything -----------
async function initialize(){
    await initializeHandsPose();
    await initializeCamera();
    updatePredictionStatus();
}
initialize();
</script>
</body>
</html>
